;; Generated by mirage.%%VERSION%%

(executable
  (name config)
  (flags (:standard -warn-error -A))
  (modules config)
  (libraries mirage))

(rule
  (targets key_gen.ml main.ml manifest.json manifest.ml)
  (deps config.ml mirage.context)
  (action
    (run ./config.exe build --context-file mirage.context)))

(rule
  (targets static_htdocs.ml static_htdocs.mli)
  (deps (source_tree htdocs))
  (action
    (run ocaml-crunch -o static_htdocs.ml htdocs)))

(rule
  (targets static_tls.ml static_tls.mli)
  (deps (source_tree tls))
  (action
    (run ocaml-crunch -o static_tls.ml tls)))

(executable
  (enabled_if (= %{context_name} "mirage-hvt"))
  (name main)
  (modes (native object))
  (libraries ocaml-freestanding arp-mirage cohttp-mirage conduit-mirage ethernet lwt magic-mime mirage-bootvar-solo5 mirage-clock-freestanding mirage-crypto-entropy mirage-kv-mem mirage-logs mirage-net-solo5 mirage-runtime mirage-solo5 mirage-types tcpip tcpip.icmpv4 tcpip.ipv4 tcpip.stack-direct tcpip.tcp tcpip.udp tls-mirage uri)
  (link_flags -g -w +A-4-41-42-44 -bin-annot -strict-sequence -principal -safe-string)
  (modules (:standard \ config manifest))
  (foreign_stubs (language c) (names manifest))
  (forbidden_libraries unix))

(rule
  (targets manifest.c)
  (deps manifest.json (package solo5))
  (action (run solo5-elftool gen-manifest manifest.json manifest.c)))

(rule (copy %{lib:solo5-hvt:ldflags} solo5-hvt-ldflags))

(rule (copy %{lib:ocaml-freestanding:ldflags} freestanding-ldflags))

(rule
  (target https.hvt)
  (enabled_if (= %{context_name} "mirage-hvt"))
  (mode (promote (until-clean)))
  (deps main.exe.o solo5-hvt-ldflags freestanding-ldflags)
  (action
    (bash
      "ld -verbose \
         $(cat $(realpath solo5-hvt-ldflags)) main.exe.o -o %{target} \
         $(cat $(realpath freestanding-ldflags))")))

(rule (copy %{lib:solo5-hvt:cflags} solo5-hvt-cflags))

(rule (copy %{lib:ocaml-freestanding:cflags} freestanding-cflags))

;(install
;  (files https.hvt)
;  need ocaml/dune#3354
;  (enabled_if (= %{context_name} "mirage-hvt"))
;  (section bin)
;  (package https))
